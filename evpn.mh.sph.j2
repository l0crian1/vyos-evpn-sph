#!/usr/sbin/nft -f

{% if netdev_table_exists %}
delete table netdev evpn_sph
{% endif %}

{% if bridge_table_exists %}
delete table bridge evpn_sph
{% endif %}

{% if vteps %}
table netdev evpn_sph {
        set vteps {
                type ipv4_addr
                flags interval
                elements = { {{ vteps | join(", ") }} }
        }

        chain evpn_sph_ingress {
                type filter hook ingress devices = { {{ underlay_iface | join(", ") }} } priority filter; policy accept;
{%     if df_interfaces %}
                ip saddr @vteps udp dport 4789 meta mark set 0x04fc867d counter accept
{%     endif %}
        }
}

table bridge evpn_sph {
{% if df_interfaces %}
        set df_bonds {
                type ifname
                flags interval
                auto-merge
                elements = { {{ df_interfaces | quoted_join(", ") }} }
        }
{% endif %}

{% if non_df_interfaces %}
        set non_df_bonds {
                type ifname
                flags interval
                auto-merge
                elements = { {{ non_df_interfaces | quoted_join(", ") }} }
        }
{% endif %}

        chain evpn_sph_forward {
                type filter hook forward priority 0; policy accept;
{%     if df_interfaces %}
                oifname @df_bonds meta mark 0x04fc867d meta pkttype { multicast, broadcast } counter drop
{%     endif %}
{%     if non_df_interfaces %}
                iifname "vxlan*" oifname @non_df_bonds meta pkttype { multicast, broadcast } counter drop
{%     endif %}
        }
}
{% endif %}
