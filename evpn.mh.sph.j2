#!/usr/sbin/nft -f

{% if netdev_table_exists %}
delete table netdev evpn_sph
{% endif %}

{% if bridge_table_exists %}
delete table bridge evpn_sph
{% endif %}

{% if vteps is vyos_defined %}
table netdev evpn_sph {
        set vteps {
                type ipv4_addr
                flags interval
                elements = { {{ vteps }} }
        }

        chain evpn_sph_ingress {
                type filter hook ingress devices = { eth1, eth3 } priority filter; policy accept;
                ip saddr @vteps udp dport 4789 meta mark set 0x04fc867d counter
        }
}

table bridge evpn_sph {
        chain evpn_sph_forward {
                type filter hook forward priority 0; policy accept;
{%     for iface in interfaces %}
                oifname {{ iface }} meta mark 0x04fc867d meta pkttype { multicast, broadcast } counter drop
{%     endfor %}
        }
}
{% endif %}
